bitmap_lib = {}
bitmap_lib["hao"] = string.char(0x20,0x00,0x27,0xC0,0x20,0x40,0xF8,0x80,0x49,0x00,0x49,0x00,0x4F,0xE0,0x91,0x00,0x51,0x00,0x21,0x00,0x51,0x00,0x8B,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00)
bitmap_lib["zhong"] = string.char(0x04,0x00,0x04,0x00,0x04,0x00,0x7F,0xC0,0x44,0x40,0x44,0x40,0x44,0x40,0x7F,0xC0,0x44,0x40,0x04,0x00,0x04,0x00,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00)
bitmap_lib["deng"] = string.char(
0x42,0x00,0x7B,0xE0,0x94,0x80,0x04,0x00,0x7F,0xC0,0x04,0x00,0xFF,0xE0,0x01,0x00,0xFF,0xE0,0x21,0x00,0x11,0x00,0x07,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00)
bitmap_lib["bu"] = string.char(0x00,0x00,0xFF,0xC0,0x04,0x00,0x04,0x00,0x08,0x00,0x1A,0x00,0x29,0x00,0x48,0x80,0x88,0x40,0x08,0x00,0x08,0x00,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00)
bitmap_lib["shi"] = string.char(0x40,0xC0,0x27,0x00,0x01,0x00,0x01,0x00,0xEF,0xE0,0x21,0x00,0x27,0xC0,0x24,0x40,0x24,0x40,0x27,0xC0,0x50,0x00,0x8F,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00)
bitmap_lib["yu"] = string.char(0xFF,0x80,0x08,0x00,0x08,0x00,0x08,0x00,0x08,0x00,0xFF,0xC0,0x08,0x00,0x08,0x00,0x08,0x00,0x08,0x00,0x08,0x00,0x38,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00)
bitmap_lib["min"] = string.char(0x41,0x00,0x7D,0x00,0x81,0x00,0x7D,0xE0,0x46,0x40,0x55,0x40,0xFF,0x40,0x45,0x40,0x55,0x40,0x7E,0x80,0x05,0x40,0x1A,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00)
bitmap_lib["gan"] = string.char(0x01,0x40,0x7F,0xE0,0x41,0x00,0x5D,0x40,0x41,0x40,0x5C,0x80,0x54,0xA0,0x5D,0x60,0x82,0x20,0x54,0x40,0x52,0xA0,0x8F,0xA0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00)
bitmap_lib["ren"] = string.char(0x04,0x00,0x04,0x00,0x04,0x00,0x04,0x00,0x04,0x00,0x0A,0x00,0x0A,0x00,0x11,0x00,0x11,0x00,0x20,0x80,0x40,0x40,0x80,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00)
bitmap_lib["qun"] = string.char(0x02,0x20,0x79,0x40,0x2B,0xE0,0xFC,0x80,0x28,0x80,0x7B,0xE0,0x20,0x80,0x78,0x80,0x6B,0xE0,0xA8,0x80,0x38,0x80,0x28,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00)
bitmap_lib["jian"] = string.char(0x21,0x00,0x23,0xC0,0x59,0x40,0x4F,0xE0,0xC9,0x40,0x53,0xC0,0x59,0x00,0x4F,0xC0,0x49,0x00,0x5F,0xE0,0x49,0x00,0x57,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00)
bitmap_lib["kang"] = string.char(0x04,0x00,0x7F,0xE0,0x42,0x00,0x5F,0xC0,0x42,0x40,0x7F,0xE0,0x42,0x40,0x5F,0xC0,0x42,0x00,0x57,0x40,0x4A,0x80,0x96,0x60,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00)
bitmap_lib["fei"] = string.char(0x0A,0x00,0x0A,0x00,0xFB,0xE0,0x0A,0x00,0x0A,0x00,0x7B,0xC0,0x0A,0x00,0x0A,0x00,0xFB,0xE0,0x0A,0x00,0x0A,0x00,0x0A,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00)
bitmap_lib["chang"] = string.char(0x24,0x80,0x15,0x00,0xFF,0xE0,0x80,0x20,0x3F,0x80,0x20,0x80,0x3F,0x80,0x04,0x00,0x7F,0xC0,0x44,0x40,0x44,0xC0,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00)
bitmap_lib["wei"] = string.char(0x10,0x00,0x1F,0x80,0x20,0x80,0x7F,0xE0,0xA0,0x00,0x2F,0xC0,0x28,0x40,0x28,0x40,0x29,0x80,0x48,0x20,0x48,0x20,0x87,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00)
bitmap_lib["xian"] = string.char(0x01,0x00,0xF1,0x00,0x92,0x80,0x94,0x40,0xA8,0x20,0xA7,0xC0,0x90,0x00,0x92,0x40,0x99,0x40,0xE5,0x40,0x84,0x80,0x8F,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00)
bitmap_lib["jia"] = string.char(0x00,0x00,0x3F,0xF8,0x21,0x08,0x21,0x08,0x21,0x08,0x3F,0xF8,0x21,0x08,0x21,0x08,0x21,0x08,0x3F,0xF8,0x21,0x08,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00)
bitmap_lib["quan"] = string.char(0x00,0x44,0xFE,0x44,0x28,0xFE,0x28,0x44,0xFE,0x10,0xAA,0x28,0xAA,0x44,0xAA,0x82,0xAE,0x7C,0xC2,0x10,0x82,0x10,0xFE,0x7C,0x82,0x10,0x82,0x10,0xFE,0xFE,0x82,0x00)

 
function initI2C()
   local sda = 4 -- GPIO2
   local scl = 3 -- GPIO0
   local sla = 0x3c
   i2c.setup(0, sda, scl, i2c.SLOW)
   disp = u8g.ssd1306_128x64_i2c(sla)
end 


function circles()
   disp:setColorIndex(1)
   disp:drawCircle(40, 0, 40) -- 128 ->  x 64
   disp:drawCircle(116, 35, 10) -- 128 ->  x 64
   disp:setFont(u8g.font_6x10)
   disp:drawStr(90, 10, "     C")
   disp:drawStr180(120, 0, ".")   
   disp:drawStr(90, 21, "     %")  
   disp:drawStr(0, 52, "    ug/m3")
   disp:drawStr(0, 63, "    ug/m3")
   disp:drawStr(96, 42, "2")
   disp:drawStr(110, 63, "ppm") 
   if  temp < 10 then  disp:drawStr(96, 10, temp) 
   else disp:drawStr(90, 10, temp)  end 
   if  hum < 10 then  disp:drawStr(96, 21, hum) 
   else disp:drawStr(90, 21, hum)  end 
   if  pm25 < 100 then  disp:drawStr(6, 52, pm25) 
   else disp:drawStr(0, 52, pm25) end
   if  pm10 < 100 then  disp:drawStr(6, 63, pm10) 
   else disp:drawStr(0, 63, pm10) end
   if aqi1 < 50 then 
     disp:drawBitmap(34,0,2,16,bitmap_lib["hao"])
   elseif aqi1 < 100 then 
     disp:drawBitmap(27,0,2,16,bitmap_lib["zhong"])
     disp:drawBitmap(41,0,2,16,bitmap_lib["deng"])
   elseif aqi1 < 150 then 
     disp:drawBitmap(2,0,2,16,bitmap_lib["bu"])
     disp:drawBitmap(13,0,2,16,bitmap_lib["shi"])
     disp:drawBitmap(24,0,2,16,bitmap_lib["yu"])
     disp:drawBitmap(34,0,2,16,bitmap_lib["min"])
     disp:drawBitmap(46,0,2,16,bitmap_lib["gan"])
     disp:drawBitmap(57,0,2,16,bitmap_lib["ren"])
     disp:drawBitmap(67,0,2,16,bitmap_lib["qun"])
   elseif aqi1 < 200 then 
     disp:drawBitmap(13,0,2,16,bitmap_lib["fei"])
     disp:drawBitmap(24,0,2,16,bitmap_lib["chang"])
     disp:drawBitmap(35,0,2,16,bitmap_lib["bu"])
     disp:drawBitmap(46,0,2,16,bitmap_lib["jian"])
     disp:drawBitmap(57,0,2,16,bitmap_lib["kang"])
   elseif aqi1 < 300 then 
     disp:drawBitmap(24,0,2,16,bitmap_lib["bu"])
     disp:drawBitmap(35,0,2,16,bitmap_lib["jian"])
     disp:drawBitmap(46,0,2,16,bitmap_lib["kang"])
   elseif aqi1 < 500 then 
     disp:drawBitmap(27,0,2,16,bitmap_lib["wei"])
     disp:drawBitmap(41,0,2,16,bitmap_lib["xian"])
   else
     disp:drawBitmap(13,0,2,16,bitmap_lib["fei"])
     disp:drawBitmap(27,0,2,16,bitmap_lib["chang"])
     disp:drawBitmap(41,0,2,16,bitmap_lib["wei"])
     disp:drawBitmap(55,0,2,16,bitmap_lib["xian"])
   end   
   disp:setFont(u8g.font_10x20)
   disp:drawStr(76, 42, "CO") 
   --disp:drawBitmap(72,28,2,16,bitmap_lib["jia"])
   --disp:drawBitmap(88,28,2,16,bitmap_lib["quan"])
   str1 = string.format("%d", aqi1)
   if  aqi1 <100 then  disp:drawStr(30, 32, str1) 
   else disp:drawStr(25, 32, str1) end
   if  co2 <100 then  disp:drawStr(90, 64, co2) 
   else disp:drawStr(70, 64, co2) end
   if co2 < 450 then 
     disp:drawStr90(112,26,":")
     disp:drawStr90(109,33,"|")  
     disp:drawStr90(109,36,")")
   elseif co2 < 700 then 
     disp:drawStr90(112,26,":")   
     disp:drawStr90(109,36,")")
   elseif co2 < 1000 then 
     disp:drawStr90(112,26,":")   
     disp:drawStr90(109,34,"|")
   elseif co2 < 2500 then 
     disp:drawStr90(112,26,":")   
     disp:drawStr90(109,33,"(")
   elseif co2 < 5000 then 
     disp:drawStr90(112,26,":")   
     disp:drawStr(109,51,"~")  
     disp:drawStr(115,51,"~")
   else 
     disp:drawStr90(109,25,"X")   
     disp:drawStr90(109,34,"O")
   end
end

function ticker()
   disp:firstPage()
   repeat
      circles() 
   until disp:nextPage() == false         
end

aqi1 = 0
temp = 0.0
hum = 0.0
pm25 = 0
pm10 = 0
co2 = 0         
initI2C()  
tmr.alarm(2, 1000, 1, ticker)
 